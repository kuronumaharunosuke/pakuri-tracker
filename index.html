<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>パクリTracker - AIESEC Japan</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
:root {
  --aiesec-blue: #037EF3;
  --aiesec-blue-dark: #0260b8;
  --aiesec-teal: #0CB9C1;
  --aiesec-orange: #F48924;
  --aiesec-red: #F85A40;
  --aiesec-purple: #7552CC;
  --aiesec-green: #00c16e;
  --aiesec-yellow: #ffc845;
  --aiesec-gray: #52565E;
  --white: #ffffff;
  --bg: #f5f5f5;
  --border: #e0e0e0;
  --text: #2d2d2d;
  --text-sub: #777;
  --r: 8px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans JP','Lato',sans-serif;min-height:100vh;color:var(--text);background:var(--bg)}
input,select,textarea,button{font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--aiesec-blue)!important}

.app{max-width:720px;margin:0 auto}

/* ===== HEADER ===== */
.header{
  background:var(--aiesec-blue);
  padding:16px 20px 0;
  color:#fff;
  position:sticky;top:0;z-index:50;
}
.header-top{display:flex;justify-content:space-between;align-items:center;padding-bottom:14px}
.header-brand{display:flex;align-items:center;gap:12px}
.header-logo{height:28px;display:block}
.header-divider{width:1px;height:20px;background:rgba(255,255,255,0.3)}
.header h1{font-family:'Lato',sans-serif;font-size:17px;font-weight:900;letter-spacing:-0.3px}
.btn-add{
  background:#fff;color:var(--aiesec-blue);border:none;border-radius:var(--r);
  padding:8px 16px;font-weight:700;font-size:13px;cursor:pointer;
}
.btn-add:hover{background:rgba(255,255,255,0.9)}

.mini-stats{display:flex;border-top:1px solid rgba(255,255,255,0.2);margin:0 -20px;padding:0 20px}
.mini-stat{flex:1;padding:12px 0;text-align:center}
.mini-stat+.mini-stat{border-left:1px solid rgba(255,255,255,0.15)}
.mini-stat small{font-size:11px;opacity:0.7;font-weight:500}
.mini-stat .val{font-family:'Lato',sans-serif;font-size:20px;font-weight:900;margin-top:1px}

.tabs{display:flex;margin:0 -20px;border-top:1px solid rgba(255,255,255,0.2)}
.tab-btn{
  flex:1;padding:11px 0;border:none;
  font-weight:700;font-size:12px;cursor:pointer;
  color:rgba(255,255,255,0.65);background:transparent;
  border-bottom:3px solid transparent;
  transition:color 0.15s;
}
.tab-btn.active{color:#fff;border-bottom-color:#fff}
.tab-btn:not(.active):hover{color:rgba(255,255,255,0.85)}
.tab-btn.small{flex:none;padding:11px 20px}

.sync-badge{display:none}

/* ===== CONTENT ===== */
.content{padding:16px 20px 100px}

.search-input{
  width:100%;padding:10px 14px;border-radius:var(--r);
  border:1px solid var(--border);font-size:14px;
  background:var(--white);color:var(--text);
  margin-bottom:10px;
}
.search-input::placeholder{color:#aaa}

.filter-row{display:flex;gap:0;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0}
.filter-btn{
  padding:8px 14px;
  border:none;background:none;
  color:var(--text-sub);font-size:12px;font-weight:600;
  cursor:pointer;border-bottom:2px solid transparent;
  margin-bottom:-1px;
}
.filter-btn:hover{color:var(--text)}
.filter-btn.active{color:var(--aiesec-blue);border-bottom-color:var(--aiesec-blue)}
.sort-select{
  padding:6px 10px;border-radius:var(--r);
  border:1px solid var(--border);font-size:12px;font-weight:600;
  background:var(--white);cursor:pointer;margin-left:auto;color:var(--text);
}

/* ===== CARDS ===== */
.card{
  background:var(--white);
  border-radius:var(--r);
  padding:16px;
  border:1px solid var(--border);
  cursor:pointer;
  margin-bottom:10px;
}
.card:hover{border-color:#ccc}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.card-meta{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.cat-tag{padding:2px 10px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:0.2px}
.lc-name{font-size:11px;color:var(--text-sub);font-weight:500}
.card h3{font-size:15px;font-weight:700;line-height:1.5}
.fire-badge{text-align:center;min-width:44px;margin-left:12px}
.fire-badge.has .num{font-family:'Lato',sans-serif;font-size:22px;font-weight:900;color:var(--aiesec-blue)}
.fire-badge.empty .num{font-family:'Lato',sans-serif;font-size:22px;font-weight:900;color:#ddd}
.fire-badge small{font-size:10px;color:var(--text-sub);font-weight:600;display:block}
.card-desc{font-size:13px;color:var(--text-sub);line-height:1.6;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-bottom{display:flex;justify-content:space-between;align-items:center}
.card-date{font-size:11px;color:#aaa}
.btn-pakuri{
  background:var(--aiesec-blue);color:#fff;border:none;
  border-radius:var(--r);padding:7px 16px;
  font-weight:700;font-size:12px;cursor:pointer;
}
.btn-pakuri:hover{background:var(--aiesec-blue-dark)}

.empty-state{text-align:center;padding:60px 20px;color:#aaa}
.loading{text-align:center;padding:60px;color:#aaa}
.spinner{
  display:inline-block;width:24px;height:24px;
  border:3px solid var(--border);border-top-color:var(--aiesec-blue);
  border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:10px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== DASHBOARD ===== */
.dash-section{
  background:var(--white);border-radius:var(--r);padding:16px;
  border:1px solid var(--border);margin-bottom:12px;
}
.dash-section h3{font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text);text-transform:uppercase;letter-spacing:0.5px}
.top-card{
  background:var(--aiesec-blue);color:#fff;
  border-radius:var(--r);padding:20px;margin-bottom:12px;
}
.top-card .label{font-size:11px;font-weight:700;opacity:0.7;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px}
.top-card .name{font-size:16px;font-weight:700}
.top-card .meta{font-size:12px;opacity:0.7;margin-top:4px}

.bar-row{margin-bottom:10px}
.bar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:12px}
.bar-track{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.rank-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12px}

.kpi-row{margin-bottom:12px}
.kpi-header{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px}
.kpi-header .label{font-weight:600}
.kpi-track{height:8px;background:var(--bg);border-radius:4px;overflow:hidden}
.kpi-fill{height:100%;border-radius:4px}
.kpi-pct{font-size:11px;color:var(--text-sub);margin-top:2px}

/* ===== SETTINGS ===== */
.settings-btn{
  display:block;width:100%;padding:12px 16px;border-radius:var(--r);
  border:1px solid var(--border);background:var(--white);
  font-size:14px;font-weight:600;cursor:pointer;text-align:left;
  color:var(--text);margin-bottom:8px;
}
.settings-btn:hover{background:var(--bg)}
.settings-btn.danger{color:#d32f2f}
.settings-btn.danger:hover{background:#fff5f5}
.howto{
  margin-top:8px;padding:14px;
  background:var(--bg);border-radius:var(--r);
  font-size:12px;color:var(--text-sub);line-height:2;
}

/* ===== MODALS ===== */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.35);
  z-index:100;display:flex;align-items:flex-end;justify-content:center;
}
.overlay.center{align-items:center}
.modal{
  background:var(--white);
  border-radius:var(--r) var(--r) 0 0;
  padding:24px 20px 32px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;
  animation:slideUp 0.25s ease;
}
.modal.center-modal{border-radius:var(--r);animation:scaleIn 0.2s ease}
.modal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-top h2{font-size:17px;font-weight:700}
.btn-close{
  background:var(--bg);border:none;border-radius:50%;
  width:32px;height:32px;font-size:15px;cursor:pointer;color:var(--text-sub);
}
.btn-close:hover{background:var(--border)}
.form-group{margin-bottom:14px}
.form-group label{font-size:13px;font-weight:600;display:block;margin-bottom:4px}
.form-input{
  width:100%;padding:10px 14px;border-radius:var(--r);
  border:1px solid var(--border);font-size:14px;
  background:var(--white);color:var(--text);
}
textarea.form-input{resize:vertical}
.cat-btns{display:flex;gap:6px;flex-wrap:wrap}
.cat-btn{
  padding:6px 14px;border-radius:4px;font-size:13px;font-weight:600;
  cursor:pointer;border:1.5px solid var(--border);
  background:var(--white);color:#aaa;
}
.btn-submit{
  width:100%;background:var(--aiesec-blue);color:#fff;border:none;
  border-radius:var(--r);padding:14px;font-weight:700;font-size:14px;
  cursor:pointer;margin-top:4px;
}
.btn-submit:hover{background:var(--aiesec-blue-dark)}
.btn-submit:disabled{opacity:0.5;cursor:not-allowed}
.btn-delete{
  width:100%;background:transparent;color:#aaa;border:1px solid var(--border);
  border-radius:var(--r);padding:10px;font-weight:600;font-size:13px;
  cursor:pointer;margin-top:8px;
}
.btn-delete:hover{background:#fff5f5;color:#d32f2f;border-color:#ffcdd2}
.btn-cancel{
  flex:1;padding:12px;border-radius:var(--r);
  border:1px solid var(--border);background:var(--white);
  font-weight:600;font-size:14px;cursor:pointer;color:var(--text-sub);
}
.btn-cancel:hover{background:var(--bg)}
.btn-confirm{
  flex:1;padding:12px;border-radius:var(--r);border:none;
  background:var(--aiesec-blue);color:#fff;font-weight:700;font-size:14px;cursor:pointer;
}
.btn-confirm:hover{background:var(--aiesec-blue-dark)}

.detail-section{margin-bottom:16px}
.detail-section h4{font-size:12px;font-weight:700;color:var(--text-sub);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.detail-section p{font-size:14px;color:#444;line-height:1.7}
.pakuri-list{display:flex;flex-wrap:wrap;gap:6px}
.pakuri-chip{
  padding:4px 10px;border-radius:4px;font-size:12px;font-weight:700;
  background:var(--bg);color:var(--aiesec-blue);
}

.toast{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:var(--text);color:#fff;padding:12px 24px;border-radius:var(--r);
  font-size:13px;font-weight:600;z-index:1000;
  box-shadow:0 4px 16px rgba(0,0,0,0.15);
  animation:slideDown 0.25s ease;pointer-events:none;
}

.section-title{font-size:17px;font-weight:700;margin-bottom:14px;color:var(--text)}

@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes slideDown{from{transform:translateY(-16px) translateX(-50%);opacity:0}to{transform:translateY(0) translateX(-50%);opacity:1}}
@keyframes scaleIn{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div class="app">
<div id="toast" class="toast" style="display:none"></div>

<div class="header">
    <div class="header-top">
    <div class="header-brand">
        <img src="https://aiesec-logos.s3.eu-west-1.amazonaws.com/White-Blue-Logo.png" alt="AIESEC" class="header-logo">
        <div class="header-divider"></div>
        <h1>パクリTracker</h1>
    </div>
    <button class="btn-add" onclick="openRegister()">＋ 施策を登録</button>
    </div>
    <div class="mini-stats">
    <div class="mini-stat"><small>施策数</small><div class="val" id="stat-total">-</div></div>
    <div class="mini-stat"><small>パクリ数</small><div class="val" id="stat-pakuri">-</div></div>
    <div class="mini-stat"><small>参加LC</small><div class="val" id="stat-lcs">-</div></div>
    </div>
    <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('list',this)">施策一覧</button>
    <button class="tab-btn" onclick="switchTab('dashboard',this)">ダッシュボード</button>
    <button class="tab-btn small" onclick="switchTab('settings',this)">設定</button>
    </div>
</div>

<div class="content">
    <div id="tab-list">
    <input type="text" class="search-input" placeholder="施策名・LC名で検索..." oninput="renderList()">
    <div class="filter-row">
        <button class="filter-btn active" onclick="setFilter('all',this)">全て</button>
        <button class="filter-btn" onclick="setFilter('採用',this)">採用</button>
        <button class="filter-btn" onclick="setFilter('育成',this)">育成</button>
        <button class="filter-btn" onclick="setFilter('Planning',this)">Planning</button>
        <button class="filter-btn" onclick="setFilter('チームビルディング',this)">TB</button>
        <button class="filter-btn" onclick="setFilter('その他',this)">その他</button>
        <select class="sort-select" onchange="currentSort=this.value;renderList()">
        <option value="popular">人気順</option>
        <option value="newest">新着順</option>
        </select>
    </div>
    <div id="card-list"><div class="loading"><div class="spinner"></div><p>読み込み中...</p></div></div>
    </div>
    <div id="tab-dashboard" style="display:none"></div>
    <div id="tab-settings" style="display:none">
    <h2 class="section-title">設定</h2>
    <div class="dash-section" style="display:flex;flex-direction:column;gap:0">
        <button class="settings-btn" onclick="exportData()">データをエクスポート（JSON）</button>
        <button class="settings-btn danger" onclick="loadSampleData()">サンプルデータを投入</button>
        <div class="howto">
        <p style="font-weight:700;margin-bottom:4px">使い方</p>
        <p>1. 「施策を登録」から他LCに共有したい施策を登録</p>
        <p>2. 一覧から気になる施策を見つけたら「パクる！」</p>
        <p>3. ダッシュボードで全体の統計を確認</p>
        <p>4. データはリアルタイムで全員に共有されます</p>
        </div>
    </div>
    </div>
</div>
</div>

<!-- Modals -->
<div id="modal-register" class="overlay" style="display:none" onclick="closeRegister()">
<div class="modal" onclick="event.stopPropagation()">
    <div class="modal-top"><h2>施策を登録する</h2><button class="btn-close" onclick="closeRegister()">✕</button></div>
    <div class="form-group"><label>施策名 *</label><input id="f-name" class="form-input" placeholder="例: 新歓LINEオープンチャット施策"></div>
    <div class="form-group"><label>あなたのLC *</label><select id="f-lc" class="form-input"><option value="">選択してください</option></select></div>
    <div class="form-group"><label>カテゴリ *</label><div class="cat-btns" id="f-cat-btns"></div></div>
    <div class="form-group"><label>この施策で何をした？ *</label><textarea id="f-desc" class="form-input" rows="3" placeholder="具体的に何をしたかを書いてください"></textarea></div>
    <div class="form-group"><label>どんな成果が出た？ *</label><textarea id="f-result" class="form-input" rows="2" placeholder="数字でも定性でもOK"></textarea></div>
    <div class="form-group"><label>資料リンク（任意）</label><input id="f-link" class="form-input" placeholder="https://..."></div>
    <button class="btn-submit" id="btn-register-submit" onclick="submitRegister()">登録する</button>
</div>
</div>

<div id="modal-pakuri" class="overlay center" style="display:none" onclick="closePakuri()">
<div class="modal center-modal" style="max-width:400px;padding:24px" onclick="event.stopPropagation()">
    <h3 style="font-size:17px;font-weight:700;text-align:center;margin-bottom:4px">パクる！</h3>
    <p style="font-size:13px;color:var(--text-sub);text-align:center;margin-bottom:16px">あなたのLCを選んでください</p>
    <select id="p-lc" class="form-input" style="margin-bottom:16px"><option value="">LCを選択</option></select>
    <div style="display:flex;gap:8px">
    <button class="btn-cancel" onclick="closePakuri()">キャンセル</button>
    <button class="btn-confirm" onclick="submitPakuri()">パクる！</button>
    </div>
</div>
</div>

<div id="modal-detail" class="overlay" style="display:none" onclick="closeDetail()">
<div class="modal" onclick="event.stopPropagation()"><div id="detail-content"></div></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
apiKey:"AIzaSyByjE8Nm0Cisa_GaUJyYWbRn8EjzA4BIWc",
authDomain:"pakuri-tracker.firebaseapp.com",
projectId:"pakuri-tracker",
storageBucket:"pakuri-tracker.firebasestorage.app",
messagingSenderId:"20264679626",
appId:"1:20264679626:web:36bfff1bc3fe47f5fddc33"
});
const db=firebase.firestore(),strategiesRef=db.collection("strategies");

const CATEGORIES=["採用","育成","Planning","チームビルディング","その他"];
const LC_LIST=["HD - 北海道委員会","AG - 青山学院委員会","CH - 中央大学委員会","HI - 一橋大学委員会","JO - 上智大学委員会","KO - 慶應義塾大学委員会","MJ - 明治大学委員会","SFC - 湘南藤沢委員会","SP - 立教大学委員会","TKB - 筑波大学委員会","TO - 東京大学委員会","WA - 早稲田大学委員会","NA - 名古屋大学委員会","NI - 名古屋市立大学委員会","NZ - 南山大学委員会","DO - 同志社大学委員会","KB - 神戸大学委員会","KG - 関西学院大学委員会","KT - 京都大学委員会","OI - 大阪市立大学委員会","OS - 大阪大学委員会","SG - 滋賀大学委員会","HU - 広島委員会","APU - 立命館アジア太平洋大学委員会","FK - 福岡委員会"];
const CAT_COLORS={
"採用":{bg:"#FFF3E0",text:"#E65100",border:"#FFB74D",fill:"var(--aiesec-orange)"},
"育成":{bg:"#E8F5E9",text:"#1B5E20",border:"#81C784",fill:"var(--aiesec-green)"},
"Planning":{bg:"#E3F2FD",text:"#0D47A1",border:"#64B5F6",fill:"var(--aiesec-blue)"},
"チームビルディング":{bg:"#FCE4EC",text:"#880E4F",border:"#F48FB1",fill:"var(--aiesec-red)"},
"その他":{bg:"#ECEFF1",text:"#37474F",border:"#B0BEC5",fill:"var(--aiesec-gray)"}
};
const SAMPLE=[
{name:"新歓LINEオープンチャット施策",lc:"KO - 慶應義塾大学委員会",category:"採用",description:"新歓期に個別LINEが増えすぎてメンバーが疲弊していたため、LINEオープンチャットを作成。新入生を全員招待し、1対1は重要な人だけに絞った。",result:"対応工数80h→30hに削減。メンバー満足度UP、新入生も質問しやすい環境に。",link:"",createdAt:"2026-01-15T10:00:00Z",pakuttaLCs:["HI - 一橋大学委員会","WA - 早稲田大学委員会","TO - 東京大学委員会","OS - 大阪大学委員会"]},
{name:"チーム朝会15分フォーマット",lc:"WA - 早稲田大学委員会",category:"チームビルディング",description:"毎朝15分のスタンドアップミーティングを導入。フォーマット: ①昨日やったこと ②今日やること ③困ってること の3点のみ。Slack非同期でもOK。",result:"チーム内の情報共有が改善。タスクの重複が減少。週次MTGが30分短縮。",link:"",createdAt:"2026-01-20T10:00:00Z",pakuttaLCs:["KG - 関西学院大学委員会","DO - 同志社大学委員会"]},
{name:"Planning逆算シート",lc:"TO - 東京大学委員会",category:"Planning",description:"IXP目標から逆算してWeekly KPIを自動算出するGoogleスプレッドシートを作成。入力はIXP目標と現在値のみ。",result:"Planning時間が半減。メンバーが自分の週次目標を明確に把握。達成率15%向上。",link:"https://docs.google.com/spreadsheets/example",createdAt:"2026-02-01T10:00:00Z",pakuttaLCs:["HI - 一橋大学委員会","KO - 慶應義塾大学委員会","NA - 名古屋大学委員会","KB - 神戸大学委員会","HD - 北海道委員会","FK - 福岡委員会"]},
{name:"メンバー1on1テンプレート",lc:"HI - 一橋大学委員会",category:"育成",description:"月1回の1on1で使うNotionテンプレート。質問項目: ①今月の学び ②困っていること ③来月チャレンジしたいこと ④EBへの要望。記録が蓄積される。",result:"メンバー定着率20%改善。EBが個人の状況を把握しやすくなった。",link:"",createdAt:"2026-02-05T10:00:00Z",pakuttaLCs:["AG - 青山学院委員会"]},
{name:"Instagram運用カレンダー",lc:"SP - 立教大学委員会",category:"その他",description:"月ごとの投稿テーマとスケジュールをGoogleカレンダーで管理。テンプレートを用意して、誰でも投稿作成できるように。Canvaテンプレートも併用。",result:"投稿頻度が週1→週3に。フォロワー30%増。新歓での認知度向上。",link:"",createdAt:"2026-02-03T10:00:00Z",pakuttaLCs:["MJ - 明治大学委員会","CH - 中央大学委員会","JO - 上智大学委員会"]}
];

let strategies=[],currentFilter="all",currentSort="popular",currentCat="採用",pakuriTargetId=null;

function init(){
populateLCSelects();buildCatButtons();
strategiesRef.onSnapshot(snap=>{
    strategies=snap.docs.map(d=>({id:d.id,...d.data()}));
    updateStats();renderList();
},err=>{console.error(err)});
}

function populateLCSelects(){
["f-lc","p-lc"].forEach(id=>{
    const s=document.getElementById(id),f=s.options[0];s.innerHTML="";s.appendChild(f);
    LC_LIST.forEach(l=>{const o=document.createElement("option");o.value=l;o.textContent=l;s.appendChild(o)});
});
}
function buildCatButtons(){
const c=document.getElementById("f-cat-btns");c.innerHTML="";
CATEGORIES.forEach(cat=>{const b=document.createElement("button");b.type="button";b.className="cat-btn";b.textContent=cat;b.onclick=()=>{currentCat=cat;updateCatBtnStyles()};c.appendChild(b)});
updateCatBtnStyles();
}
function updateCatBtnStyles(){
document.querySelectorAll("#f-cat-btns .cat-btn").forEach(b=>{
    const c=b.textContent,cc=CAT_COLORS[c];
    if(c===currentCat){b.style.borderColor=cc.border;b.style.background=cc.bg;b.style.color=cc.text}
    else{b.style.borderColor="var(--border)";b.style.background="var(--white)";b.style.color="#aaa"}
});
}

function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",2500)}

function switchTab(tab,btn){
document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));btn.classList.add("active");
["list","dashboard","settings"].forEach(t=>document.getElementById("tab-"+t).style.display=t===tab?"":"none");
if(tab==="dashboard")renderDashboard();
}

function updateStats(){
document.getElementById("stat-total").textContent=strategies.length;
const tp=strategies.reduce((s,x)=>s+(x.pakuttaLCs||[]).length,0);
document.getElementById("stat-pakuri").textContent=tp;
const lcs=new Set([...strategies.map(s=>s.lc),...strategies.flatMap(s=>s.pakuttaLCs||[])]);
document.getElementById("stat-lcs").textContent=lcs.size;
}

function setFilter(cat,btn){currentFilter=cat;document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));btn.classList.add("active");renderList()}

function renderList(){
const q=(document.querySelector(".search-input")||{}).value?.toLowerCase()||"";
let items=[...strategies];
if(currentFilter!=="all")items=items.filter(s=>s.category===currentFilter);
if(q)items=items.filter(s=>s.name.toLowerCase().includes(q)||s.lc.toLowerCase().includes(q)||(s.description||"").toLowerCase().includes(q));
if(currentSort==="popular")items.sort((a,b)=>(b.pakuttaLCs||[]).length-(a.pakuttaLCs||[]).length);
else items.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

const el=document.getElementById("card-list");
if(!items.length){el.innerHTML='<div class="empty-state"><p style="font-size:14px;color:#999">施策が見つかりません</p><p style="font-size:12px;margin-top:4px;color:#bbb">最初の施策を登録しよう</p></div>';return}
el.innerHTML=items.map(s=>{
    const cc=CAT_COLORS[s.category]||CAT_COLORS["その他"],n=(s.pakuttaLCs||[]).length,d=new Date(s.createdAt).toLocaleDateString("ja-JP");
    return`<div class="card" onclick="openDetail('${s.id}')"><div class="card-top"><div style="flex:1"><div class="card-meta"><span class="cat-tag" style="background:${cc.bg};color:${cc.text}">${s.category}</span><span class="lc-name">${s.lc}</span></div><h3>${esc(s.name)}</h3></div><div class="fire-badge ${n?'has':'empty'}"><div class="num">${n}</div><small>パクリ</small></div></div><p class="card-desc">${esc(s.description)}</p><div class="card-bottom"><span class="card-date">${d}</span><button class="btn-pakuri" onclick="event.stopPropagation();openPakuri('${s.id}')">パクる！</button></div></div>`;
}).join("");
}

function openDetail(id){
const s=strategies.find(x=>x.id===id);if(!s)return;
const cc=CAT_COLORS[s.category]||CAT_COLORS["その他"],d=new Date(s.createdAt).toLocaleDateString("ja-JP"),p=s.pakuttaLCs||[];
let h=`<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px"><div style="flex:1"><span class="cat-tag" style="background:${cc.bg};color:${cc.text}">${s.category}</span><h2 style="font-size:17px;font-weight:700;margin:8px 0 4px">${esc(s.name)}</h2><p style="font-size:12px;color:var(--text-sub)">${s.lc} · ${d}</p></div><button class="btn-close" onclick="closeDetail()">✕</button></div>`;
h+=`<div class="detail-section"><h4>施策内容</h4><p>${esc(s.description)}</p></div>`;
h+=`<div class="detail-section"><h4>成果</h4><p>${esc(s.result)}</p></div>`;
if(s.link)h+=`<div class="detail-section"><h4>資料</h4><a href="${esc(s.link)}" target="_blank" style="font-size:13px;color:var(--aiesec-blue);word-break:break-all;font-weight:600">${esc(s.link)}</a></div>`;
h+=`<div style="background:var(--bg);border-radius:var(--r);padding:14px;margin-bottom:16px"><h4 style="font-size:12px;font-weight:700;color:var(--text-sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">パクったLC (${p.length})</h4>${p.length===0?'<p style="font-size:13px;color:#aaa">まだ誰もパクってません。最初にパクろう！</p>':'<div class="pakuri-list">'+p.map(l=>`<span class="pakuri-chip">${l.split(" - ")[0]}</span>`).join("")+'</div>'}</div>`;
h+=`<button class="btn-submit" onclick="closeDetail();openPakuri('${s.id}')">この施策をパクる</button>`;
h+=`<button class="btn-delete" onclick="confirmDelete('${s.id}')">この施策を削除する</button>`;
document.getElementById("detail-content").innerHTML=h;
document.getElementById("modal-detail").style.display="flex";
}
function closeDetail(){document.getElementById("modal-detail").style.display="none"}

function openRegister(){
["f-name","f-desc","f-result","f-link"].forEach(id=>document.getElementById(id).value="");
document.getElementById("f-lc").value="";currentCat="採用";updateCatBtnStyles();
const b=document.getElementById("btn-register-submit");b.disabled=false;b.textContent="登録する";
document.getElementById("modal-register").style.display="flex";
}
function closeRegister(){document.getElementById("modal-register").style.display="none"}

async function submitRegister(){
const name=document.getElementById("f-name").value.trim(),lc=document.getElementById("f-lc").value;
const desc=document.getElementById("f-desc").value.trim(),result=document.getElementById("f-result").value.trim();
const link=document.getElementById("f-link").value.trim();
if(!name||!lc||!desc||!result){showToast("必須項目を入力してください");return}
const btn=document.getElementById("btn-register-submit");btn.disabled=true;btn.textContent="登録中...";
try{await strategiesRef.add({name,lc,category:currentCat,description:desc,result,link,createdAt:new Date().toISOString(),pakuttaLCs:[]});closeRegister();showToast("施策を登録しました")}
catch(e){console.error(e);showToast("エラーが発生しました");btn.disabled=false;btn.textContent="登録する"}
}

function openPakuri(id){pakuriTargetId=id;document.getElementById("p-lc").value="";document.getElementById("modal-pakuri").style.display="flex"}
function closePakuri(){document.getElementById("modal-pakuri").style.display="none";pakuriTargetId=null}

async function submitPakuri(){
const lc=document.getElementById("p-lc").value;
if(!lc){showToast("LCを選択してください");return}
const s=strategies.find(x=>x.id===pakuriTargetId);if(!s)return;
if((s.pakuttaLCs||[]).includes(lc)){showToast("このLCは既にパクり済みです");closePakuri();return}
try{await strategiesRef.doc(pakuriTargetId).update({pakuttaLCs:firebase.firestore.FieldValue.arrayUnion(lc)});closePakuri();showToast("パクり完了！")}
catch(e){console.error(e);showToast("エラーが発生しました")}
}

function renderDashboard(){
const tp=strategies.reduce((s,x)=>s+(x.pakuttaLCs||[]).length,0);
const top=[...strategies].sort((a,b)=>(b.pakuttaLCs||[]).length-(a.pakuttaLCs||[]).length)[0];
const catStats={};CATEGORIES.forEach(c=>{const it=strategies.filter(s=>s.category===c);catStats[c]={count:it.length,pakuri:it.reduce((s,x)=>s+(x.pakuttaLCs||[]).length,0)}});
const maxP=Math.max(...Object.values(catStats).map(s=>s.pakuri),1);
const lcP={},lcR={};
strategies.forEach(s=>{lcR[s.lc]=(lcR[s.lc]||0)+1;(s.pakuttaLCs||[]).forEach(l=>{lcP[l]=(lcP[l]||0)+1})});
const tP=Object.entries(lcP).sort((a,b)=>b[1]-a[1]).slice(0,5),tR=Object.entries(lcR).sort((a,b)=>b[1]-a[1]).slice(0,5);
let h='<h2 class="section-title">ダッシュボード</h2>';
if(top)h+=`<div class="top-card"><div class="label">Most Popular</div><div class="name">${esc(top.name)}</div><div class="meta">${top.lc} · ${(top.pakuttaLCs||[]).length} LCがパクった</div></div>`;
h+='<div class="dash-section"><h3>カテゴリ別</h3>';
CATEGORIES.forEach(c=>{const cc=CAT_COLORS[c],st=catStats[c];h+=`<div class="bar-row"><div class="bar-header"><span style="font-weight:600;color:${cc.text}">${c}</span><span style="color:var(--text-sub)">${st.count}施策 · ${st.pakuri}パクリ</span></div><div class="bar-track"><div class="bar-fill" style="width:${(st.pakuri/maxP)*100}%;background:${cc.fill}"></div></div></div>`});
h+='</div><div class="grid-2"><div class="dash-section"><h3>パクリ王 TOP5</h3>';
if(!tP.length)h+='<p style="font-size:12px;color:#aaa">データなし</p>';
else tP.forEach(([l,n],i)=>{h+=`<div class="rank-item"><span>${i+1}. ${l.split(" - ")[0]}</span><span style="font-weight:700;color:var(--aiesec-blue)">${n}</span></div>`});
h+='</div><div class="dash-section"><h3>登録王 TOP5</h3>';
if(!tR.length)h+='<p style="font-size:12px;color:#aaa">データなし</p>';
else tR.forEach(([l,n],i)=>{h+=`<div class="rank-item"><span>${i+1}. ${l.split(" - ")[0]}</span><span style="font-weight:700;color:var(--aiesec-teal)">${n}</span></div>`});
h+='</div></div><div class="dash-section"><h3>KPI進捗</h3>';
[{label:"施策登録数",cur:strategies.length,tar:100,col:"var(--aiesec-teal)"},{label:"パクリ実装数",cur:tp,tar:300,col:"var(--aiesec-blue)"}].forEach(k=>{
    const p=Math.round((k.cur/k.tar)*100);
    h+=`<div class="kpi-row"><div class="kpi-header"><span class="label">${k.label}</span><span style="color:${k.col};font-weight:700">${k.cur} / ${k.tar}</span></div><div class="kpi-track"><div class="kpi-fill" style="width:${Math.min(p,100)}%;background:${k.col}"></div></div><div class="kpi-pct">達成率: ${p}%</div></div>`;
});
h+='</div>';
document.getElementById("tab-dashboard").innerHTML=h;
}

function exportData(){
const b=new Blob([JSON.stringify(strategies,null,2)],{type:"application/json"});
const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="pakuri-tracker-data.json";a.click();
showToast("エクスポートしました");
}

async function loadSampleData(){
if(!confirm("サンプルデータ5件を投入しますか？"))return;
try{const batch=db.batch();SAMPLE.forEach(s=>batch.set(strategiesRef.doc(),s));await batch.commit();showToast("サンプルデータを投入しました")}
catch(e){console.error(e);showToast("エラーが発生しました")}
}

async function confirmDelete(id){
const s=strategies.find(x=>x.id===id);if(!s)return;
if(!confirm(`「${s.name}」を削除しますか？\nこの操作は取り消せません。`))return;
try{await strategiesRef.doc(id).delete();closeDetail();showToast("施策を削除しました")}
catch(e){console.error(e);showToast("削除に失敗しました")}
}

function esc(s){if(!s)return"";const d=document.createElement("div");d.textContent=s;return d.innerHTML}
init();
</script>
</body>
</html>
